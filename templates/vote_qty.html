{% extends "base.html" %}
{% set title = "Vote • " ~ show["title"] %}

{% block content %}
<div class="max-w-4xl">

  <!-- Sponsor Bar -->
  <section class="rounded-3xl bg-white border border-slate-200 shadow-sm p-6">
    <div class="text-xs font-semibold text-slate-500">TITLE SPONSOR</div>
    <div class="mt-2 rounded-2xl border border-slate-200 bg-slate-50 p-4 flex items-center justify-between gap-4">
      <div class="min-w-0">
        <div class="font-semibold">Your Title Sponsor Here</div>
        <div class="text-sm text-slate-600">Replace with title sponsor logo + name.</div>
      </div>
      <div class="h-12 w-28 rounded-xl border border-dashed border-slate-300 grid place-items-center text-xs text-slate-500">Logo</div>
    </div>

    <div class="mt-5 text-xs font-semibold text-slate-500">SPONSORS</div>
    <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
      {% for i in range(6) %}
        <div class="h-14 rounded-2xl border border-dashed border-slate-300 bg-white grid place-items-center text-xs text-slate-500">Sponsor</div>
      {% endfor %}
    </div>
  </section>

  <!-- Voting -->
  <section class="mt-6 rounded-3xl bg-white border border-slate-200 shadow-sm p-6">
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
      <div>
        <div class="text-xs font-semibold text-slate-500">VOTING</div>
        <h1 class="mt-1 text-3xl font-semibold tracking-tight">Car #{{ car["car_number"] }}</h1>
        <div class="mt-1 text-slate-700">{{ car["year"] }} {{ car["make"] }} {{ car["model"] }}</div>
        <div class="text-sm text-slate-600 mt-2">
          Category: <span class="font-semibold text-slate-900">{{ category_name }}</span>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 w-full md:w-80">
        <div class="font-semibold">$1 per vote</div>
        <div class="text-sm text-slate-600 mt-1">Choose how many votes, then pay securely with card.</div>
      </div>
    </div>

    <div class="mt-6 grid gap-4">
      <div>
        <label class="text-sm font-semibold">How many votes?</label>
        <div class="mt-2 grid grid-cols-3 sm:grid-cols-6 gap-2">
          {% for n in [1,2,3,5,10,20] %}
            <button type="button"
              class="qty px-3 py-3 rounded-2xl border border-slate-200 hover:bg-slate-50 font-semibold"
              data-qty="{{ n }}">{{ n }}</button>
          {% endfor %}
        </div>

        <div class="mt-3 flex items-center gap-3">
          <input id="customQty" inputmode="numeric" placeholder="Custom"
                 class="w-32 rounded-2xl border border-slate-200 px-4 py-3">
          <div class="text-sm text-slate-600">Total: <span id="total" class="font-semibold">$1</span></div>
        </div>

        <div class="text-xs text-slate-500 mt-2">Max 50 per checkout (repeat if desired).</div>
      </div>

      <button id="payBtn" class="px-5 py-4 rounded-2xl bg-slate-900 text-white hover:opacity-90 text-lg font-semibold">
        Pay & submit votes
      </button>

      <div id="msg" class="text-sm"></div>

      <div class="text-xs text-slate-500">
        You’ll be redirected to Stripe Checkout. Votes are recorded only after payment succeeds.
      </div>
    </div>
  </section>
</div>

<script>
  let selectedQty = 1;
  const totalEl = document.getElementById("total");
  const msg = document.getElementById("msg");
  const customQty = document.getElementById("customQty");

  function setQty(n) {
    selectedQty = n;
    totalEl.textContent = "$" + (n * 1).toString();
    msg.textContent = "";
  }

  document.querySelectorAll(".qty").forEach(b => {
    b.addEventListener("click", () => setQty(parseInt(b.dataset.qty, 10)));
  });

  customQty.addEventListener("input", () => {
    const v = parseInt(customQty.value || "0", 10);
    if (!isNaN(v) && v > 0) setQty(v);
  });

  document.getElementById("payBtn").addEventListener("click", async () => {
    msg.textContent = "";
    const qty = selectedQty;

    if (!qty || qty < 1 || qty > 50) {
      msg.className = "text-sm text-red-700";
      msg.textContent = "Vote quantity must be between 1 and 50.";
      return;
    }

    const form = new FormData();
    form.append("show_slug", "{{ show['slug'] }}");
    form.append("car_token", "{{ car['car_token'] }}");
    form.append("category_slug", "{{ category_slug }}");
    form.append("vote_qty", qty.toString());

    try {
      const res = await fetch("{{ url_for('create_checkout_session') }}", { method: "POST", body: form });
      const json = await res.json();

      if (!json.ok) {
        msg.className = "text-sm text-red-700";
        msg.textContent = json.error || "Unable to start checkout.";
        return;
      }

      window.location.href = json.checkout_url;
    } catch (e) {
      msg.className = "text-sm text-red-700";
      msg.textContent = "Network error. Please try again.";
    }
  });

  setQty(1);
</script>
{% endblock %}

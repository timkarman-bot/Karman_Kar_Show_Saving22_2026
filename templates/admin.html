{% extends "base.html" %}
{% set title = "Admin • Karman Kar Shows & Events" %}

{% block content %}
<div class="max-w-5xl">
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
    <div>
      <div class="text-xs font-semibold text-slate-500">RESTRICTED</div>
      <h1 class="mt-1 text-3xl font-semibold tracking-tight">Admin</h1>
      <p class="mt-2 text-slate-600">Controls for the active show.</p>
    </div>

    {% if show %}
      <div class="text-sm text-slate-600">
        <div class="font-semibold text-slate-900">{{ show["title"] }}</div>
        <div>
          {% if show["date"] %}{{ show["date"] }}{% endif %}
          {% if show["location_name"] %} • {{ show["location_name"] }}{% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  {% if not authed %}
    <div class="mt-6 rounded-3xl bg-white border border-slate-200 shadow-sm p-6 max-w-md">
      <form method="POST" action="{{ url_for('admin_login') }}" class="grid gap-3">
        <input type="hidden" name="next" value="{{ next or '' }}">

        <label class="text-sm font-semibold">Admin password</label>
        <input name="password" type="password"
               class="w-full rounded-2xl border border-slate-200 px-4 py-3"
               placeholder="Enter password" />

        {% if login_error %}
          <div class="text-sm text-red-700">{{ login_error }}</div>
        {% endif %}

        <button class="btn btn-primary" type="submit">Sign in</button>
      </form>
    </div>
  {% else %}

    <div class="mt-6 grid gap-4">
      <div class="rounded-3xl bg-white border border-slate-200 shadow-sm p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="text-xs font-semibold text-slate-500">VOTING STATUS</div>
            <div class="mt-1 text-2xl font-semibold">
              {% if show and show["voting_open"] == 1 %}Open{% else %}Closed{% endif %}
            </div>
            <div class="mt-2 text-sm text-slate-600">One-click control for pausing and resuming voting.</div>
          </div>

          <div class="flex flex-wrap gap-2">
            <form method="POST" action="{{ url_for('admin_toggle_voting') }}">
              <button class="btn btn-primary" type="submit">Toggle voting</button>
            </form>

            <form method="POST" action="{{ url_for('admin_open_voting') }}">
              <button class="btn btn-outline" type="submit">Open voting</button>
            </form>

            <form method="POST" action="{{ url_for('admin_close_voting') }}">
              <button class="btn btn-outline" type="submit">Close voting</button>
            </form>

            <form method="POST" action="{{ url_for('admin_logout') }}">
              <button class="btn btn-outline" type="submit">Sign out</button>
            </form>
          </div>
        </div>
      </div>

      <div class="rounded-3xl bg-white border border-slate-200 shadow-sm p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="text-xs font-semibold text-slate-500">REGISTRATION SETTINGS</div>
            <div class="mt-1 text-2xl font-semibold">Pre-registration control</div>
            <div class="mt-2 text-sm text-slate-600">
              Pop-up shows default to on-site registration. Full shows default to pre-registration.
              Override only when you need an exception.
            </div>
          </div>
        </div>

        <form class="mt-5 grid gap-4 max-w-xl" method="POST" action="{{ url_for('admin_show_settings') }}">
          <div>
            <label class="text-sm font-semibold">Show type</label>
            <select name="show_type" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-3">
              <option value="popup" {% if show and show["show_type"] == "popup" %}selected{% endif %}>
                Pop-Up (default: no pre-registration)
              </option>
              <option value="full" {% if not show or show["show_type"] != "popup" %}selected{% endif %}>
                Full Show (default: pre-registration)
              </option>
            </select>
          </div>

          <div>
            <label class="text-sm font-semibold">Pre-registration override</label>
            <select name="allow_prereg_override" class="mt-1 w-full rounded-2xl border border-slate-200 px-4 py-3">
              <option value="" {% if show and show["allow_prereg_override"] is none %}selected{% endif %}>
                Default (based on show type)
              </option>
              <option value="0" {% if show and show["allow_prereg_override"] == 0 %}selected{% endif %}>
                Force OFF
              </option>
              <option value="1" {% if show and show["allow_prereg_override"] == 1 %}selected{% endif %}>
                Force ON
              </option>
            </select>
            <div class="mt-2 text-xs text-slate-500">
              Recommended: leave at Default. Use Force ON/OFF only for special cases.
            </div>
          </div>

          <button class="btn btn-primary w-fit" type="submit">Save registration settings</button>
        </form>
      </div>

      <div class="rounded-3xl bg-white border border-slate-200 shadow-sm p-6">
        <div class="text-xs font-semibold text-slate-500">ACTIONS</div>

        <div class="mt-4 flex flex-wrap gap-3">
          <a class="btn btn-outline" href="{{ url_for('admin_leaderboard') }}">View leaderboard</a>
          <a class="btn btn-outline" href="{{ url_for('admin_export_votes') }}">Export votes CSV</a>
          <a class="btn btn-outline" href="{{ url_for('admin_sponsors') }}">Sponsors</a>
          <a class="btn btn-outline" href="{{ url_for('admin_placeholders') }}">Placeholder cars</a>

          <a class="px-4 py-2 rounded-xl border border-slate-200 hover:bg-slate-50"
             href="{{ url_for('admin_export_snapshot_zip') }}">
            Export snapshot (ZIP)
          </a>

          <form method="POST" action="{{ url_for('admin_close_voting_and_export') }}"
                onsubmit="return confirm('This will CLOSE voting and download a snapshot ZIP. Continue?');">
            <button class="px-4 py-2 rounded-xl border border-slate-200 hover:bg-slate-50" type="submit">
              Close voting + export ZIP
            </button>
          </form>

          <form method="POST" action="{{ url_for('admin_reset_votes') }}"
                onsubmit="return confirm('Reset ALL votes for the active show? This cannot be undone.');">
            <button class="btn btn-outline border-red-200 text-red-700 hover:bg-red-50" type="submit">
              Reset votes
            </button>
          </form>
        </div>

        <div class="mt-3 text-xs text-slate-500">
          Leaderboards are restricted to admin only.
        </div>
      </div>
    </div>

  {% endif %}
</div>
{% endblock %}

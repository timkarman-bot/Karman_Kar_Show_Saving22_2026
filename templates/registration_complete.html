{% extends "base.html" %}
{% set title = "Windshield Cards • " ~ show["title"] %}

{% block content %}
<style>
  @media print {
    header, footer, .no-print { display: none !important; }
    main { padding: 0 !important; }
    a { text-decoration: none !important; color: inherit !important; }
    .page { page-break-after: always; }
  }
</style>

<div class="max-w-6xl no-print">
  <div class="rounded-3xl bg-white border border-slate-200 shadow-sm p-6">
    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-600 text-white text-xs">
      Cards ready
    </div>
    <h1 class="mt-4 text-3xl font-semibold tracking-tight">Car #{{ car["car_number"] }}</h1>
    <div class="mt-1 text-slate-700">{{ car["year"] }} {{ car["make"] }} {{ car["model"] }} • Owner: {{ car["owner_name"] or "—" }}</div>

    <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4">
      <div class="font-semibold">Printing tips</div>
      <div class="mt-1 text-sm text-slate-600">
        These print with dark borders and high-contrast QR codes for cheap paper and sunlight.
      </div>
    </div>

    <div class="mt-5 flex flex-wrap gap-3">
      <button onclick="window.print()" class="btn btn-primary">Print (2 pages)</button>
      <a class="btn btn-outline" href="{{ url_for('show_page', slug=show['slug']) }}">Back to show</a>
    </div>
  </div>
</div>

<!-- PAGE 1: VOTING QR CODES -->
<section class="page mt-6 rounded-3xl bg-white shadow-sm print-border p-6">
  <div class="flex items-start justify-between gap-4">
    <div>
      <div class="text-xs font-semibold text-slate-600">WINDSHIELD VOTING</div>
      <div class="mt-2 text-3xl font-extrabold tracking-tight">CAR #{{ car["car_number"] }}</div>
      <div class="mt-1 text-sm text-slate-700">{{ car["year"] }} {{ car["make"] }} {{ car["model"] }}</div>
      <div class="mt-1 text-sm text-slate-700">Owner: <span class="font-semibold">{{ car["owner_name"] or "—" }}</span></div>
      <div class="mt-2 text-xs text-slate-600">{{ show["title"] }}</div>
    </div>

    <div class="text-right">
      <div class="text-xs font-semibold text-slate-600">TITLE SPONSOR</div>
      <div class="mt-2 h-14 w-44 rounded-xl print-border-soft grid place-items-center overflow-hidden bg-white">
        {% if title_sponsor and title_sponsor["logo_path"] %}
          <img class="h-full w-full object-contain p-2" src="{{ url_for('static', filename=title_sponsor['logo_path']) }}" alt="{{ title_sponsor['name'] }}">
        {% else %}
          <div class="text-xs text-slate-600">Logo</div>
        {% endif %}
      </div>
      {% if title_sponsor %}
        <div class="mt-1 text-xs font-semibold text-slate-700">{{ title_sponsor["name"] }}</div>
      {% endif %}
    </div>
  </div>

  <div class="mt-4 rounded-2xl print-border-soft bg-white p-4">
    <div class="font-semibold text-slate-900">How to vote</div>
    <div class="mt-1 text-sm text-slate-700">
      Scan your category → choose vote quantity → pay $1 per vote.
    </div>
  </div>

  {% if sponsors and sponsors|length > 0 %}
  <div class="mt-4 grid grid-cols-4 gap-2">
    {% for s in sponsors[:8] %}
      <div class="h-12 rounded-xl print-border-soft bg-white overflow-hidden grid place-items-center">
        {% if s["logo_path"] %}
          <img class="h-full w-full object-contain p-2" src="{{ url_for('static', filename=s['logo_path']) }}" alt="{{ s['name'] }}">
        {% else %}
          <div class="text-[10px] text-slate-700 px-2 text-center">{{ s["name"] }}</div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="mt-5 grid grid-cols-2 gap-3">
    {% for slug, name in CATEGORY_SLUGS.items() %}
      <div class="rounded-2xl print-border-soft p-4">
        <div class="text-[11px] font-extrabold text-slate-900">SCAN TO VOTE</div>
        <div class="mt-1 text-lg font-extrabold text-slate-900">{{ name }}</div>

        <div class="mt-3 qr-frame rounded-xl p-2 w-fit">
          <div id="qr-{{ slug }}"></div>
        </div>

        <div class="mt-2 text-[11px] text-slate-800 font-semibold">$1 per vote • Fast checkout</div>
      </div>
    {% endfor %}
  </div>

  <div class="mt-4 text-[11px] text-slate-700 font-semibold">
    Powered by Karman Kar Shows & Events • Secure payments by Stripe
  </div>
</section>

<!-- PAGE 2: OWNER CHECK-IN QR (move to back page) -->
<section class="page mt-6 rounded-3xl bg-white shadow-sm print-border p-6">
  <div class="flex items-start justify-between gap-4">
    <div>
      <div class="text-xs font-semibold text-slate-600">OWNER ONLY</div>
      <div class="mt-2 text-3xl font-extrabold tracking-tight">CHECK-IN</div>
      <div class="mt-2 text-sm text-slate-700">
        Scan this once to confirm your owner info and car details.
      </div>
      <div class="mt-3 text-sm text-slate-700 font-semibold">
        Car #{{ car["car_number"] }} • {{ car["year"] }} {{ car["make"] }} {{ car["model"] }}
      </div>
    </div>

    <div class="text-right">
      <div class="text-xs font-semibold text-slate-600">TITLE SPONSOR</div>
      <div class="mt-2 h-14 w-44 rounded-xl print-border-soft grid place-items-center overflow-hidden bg-white">
        {% if title_sponsor and title_sponsor["logo_path"] %}
          <img class="h-full w-full object-contain p-2" src="{{ url_for('static', filename=title_sponsor['logo_path']) }}" alt="{{ title_sponsor['name'] }}">
        {% else %}
          <div class="text-xs text-slate-600">Logo</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="mt-5 rounded-2xl print-border-soft p-5 bg-white">
    <div class="text-sm font-semibold text-slate-900">Scan to check-in</div>
    <div class="mt-3 qr-frame rounded-xl p-3 w-fit">
      <div id="qr-checkin"></div>
    </div>
    <div class="mt-2 text-xs text-slate-700">
      This page is not public. Phone/email are stored privately.
    </div>
  </div>

  <div class="mt-5 text-xs text-slate-700">
    Check-in URL:
    <span class="font-mono break-all">{{ url_for('checkin_page', show_slug=show['slug'], car_token=car['car_token'], _external=True) }}</span>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
  (function () {
    const items = [
      {% for slug, name in CATEGORY_SLUGS.items() %}
        { id: "qr-{{ slug }}", url: "{{ url_for('vote_qty_page', show_slug=show['slug'], car_token=car['car_token'], category_slug=slug, _external=True) }}" }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    items.forEach((it) => {
      const el = document.getElementById(it.id);
      if (!el) return;
      el.innerHTML = "";
      new QRCode(el, {
        text: it.url,
        width: 120,
        height: 120,
        correctLevel: QRCode.CorrectLevel.H
      });
    });

    const checkinEl = document.getElementById("qr-checkin");
    if (checkinEl) {
      checkinEl.innerHTML = "";
      new QRCode(checkinEl, {
        text: "{{ url_for('checkin_page', show_slug=show['slug'], car_token=car['car_token'], _external=True) }}",
        width: 160,
        height: 160,
        correctLevel: QRCode.CorrectLevel.H
      });
    }
  })();
</script>
{% endblock %}

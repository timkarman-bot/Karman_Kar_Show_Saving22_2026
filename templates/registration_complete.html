{% extends "base.html" %}
{% set title = "Registration Complete • " ~ (show["title"] if show else "Karman Kar Shows & Events") %}

{% block content %}
<style>
  @media print {
    header, footer, .no-print { display: none !important; }
    main { padding: 0 !important; }
    .print-page { box-shadow: none !important; border: none !important; }
    .print-cut { border: 1.5px dashed #94A3B8 !important; }
    a { text-decoration: none !important; color: inherit !important; }
  }

  /* QR + label contrast for sunlight + cheap paper */
  .qr-box {
    border: 2px solid #0F172A;
    border-radius: 14px;
    background: #FFF;
    padding: 8px;
  }
  .cat-box {
    border: 2px solid #0F172A;
    border-radius: 16px;
    background: #F8FAFC;
    padding: 10px 12px;
  }
  .sponsor-tile {
    border: 1.5px solid #0F172A;
    border-radius: 14px;
    background: #FFF;
    padding: 8px 10px;
  }
</style>

<div class="max-w-6xl">

  <!-- Screen-only confirmation -->
  <section class="no-print rounded-3xl bg-white border border-slate-200 shadow-sm p-6">
    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-600 text-white text-xs">
      Registration complete
    </div>

    <h1 class="mt-4 text-3xl font-semibold tracking-tight">Car #{{ car["car_number"] }}</h1>
    <div class="mt-1 text-slate-700">{{ car["year"] }} {{ car["make"] }} {{ car["model"] }}</div>

    <div class="mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4">
      <div class="font-semibold">Printing</div>
      <div class="mt-1 text-sm text-slate-600">
        Print the windshield voting sheet. Sponsor logos and all QR codes are on ONE page.
        You can also print the instructions handout for the table/registration area.
      </div>
    </div>

    <div class="mt-5 flex flex-wrap gap-3">
      <button onclick="window.print()"
              class="px-5 py-3 rounded-2xl bg-slate-900 text-white hover:opacity-90">
        Print windshield voting sheet
      </button>

      {% if show %}
        <a class="px-5 py-3 rounded-2xl bg-white border border-slate-200 hover:bg-slate-50"
           href="{{ url_for('voting_instructions', show_slug=show['slug']) }}" target="_blank" rel="noopener">
          Open/Print voting instructions
        </a>

        <a class="px-5 py-3 rounded-2xl bg-white border border-slate-200 hover:bg-slate-50"
           href="{{ url_for('show_page', slug=show['slug']) }}">
          Back to show
        </a>
      {% endif %}
    </div>
  </section>

  <!-- PRINT: ONE PAGE windshield voting sheet -->
  <section class="print-page mt-6 rounded-3xl bg-white border border-slate-200 shadow-sm p-6">
    <div class="print-cut rounded-3xl border border-slate-200 p-6">

      <!-- Header row: car info + title sponsor -->
      <div class="flex items-start justify-between gap-5">
        <div class="min-w-0">
          <div class="text-xs font-semibold text-slate-500">WINDSHIELD VOTING</div>
          <div class="mt-1 text-3xl font-semibold tracking-tight">Car #{{ car["car_number"] }}</div>
          <div class="mt-1 text-sm text-slate-800">
            {{ car["year"] }} {{ car["make"] }} {{ car["model"] }}
          </div>

          <!-- owner name allowed public (no phone/email) -->
          {% if car["owner_name"] %}
            <div class="mt-1 text-sm text-slate-700">
              Owner: <span class="font-semibold">{{ car["owner_name"] }}</span>
            </div>
          {% endif %}

          {% if show %}
            <div class="mt-2 text-xs text-slate-500">{{ show["title"] }}</div>
          {% endif %}

          <!-- Small concise eligibility note (as requested) -->
          <div class="mt-3 rounded-2xl border border-slate-200 bg-slate-50 p-3">
            <div class="text-[12px] font-semibold text-slate-800">
              Eligibility:
              <span class="font-normal text-slate-700">
                Veterans/Active Military vote for Branch awards.
                Everyone can vote for People’s Choice.
              </span>
            </div>
          </div>
        </div>

        <div class="w-64 text-right">
          <div class="text-xs font-semibold text-slate-500">TITLE SPONSOR</div>
          {% if title_sponsor %}
            <div class="mt-2 sponsor-tile">
              <div class="flex items-center justify-end gap-3">
                {% if title_sponsor["logo_path"] %}
                  <img src="{{ url_for('static', filename=title_sponsor['logo_path']) }}"
                       alt="{{ title_sponsor['name'] }}"
                       class="h-10 object-contain" />
                {% endif %}
                <div class="text-sm font-semibold text-slate-900">
                  {{ title_sponsor["name"] }}
                </div>
              </div>
            </div>
          {% else %}
            <div class="mt-2 h-12 rounded-xl border border-dashed border-slate-300 grid place-items-center text-xs text-slate-500">
              Add title sponsor in Admin
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Sponsor strip (uses whitespace on the sheet) -->
      {% if sponsors and sponsors|length > 0 %}
        <div class="mt-5">
          <div class="text-xs font-semibold text-slate-500">SPONSORS</div>
          <div class="mt-2 grid grid-cols-3 sm:grid-cols-6 gap-2">
            {% for s in sponsors %}
              <div class="sponsor-tile flex items-center justify-center">
                {% if s["logo_path"] %}
                  <img src="{{ url_for('static', filename=s['logo_path']) }}"
                       alt="{{ s['name'] }}"
                       class="h-8 object-contain" />
                {% else %}
                  <div class="text-[11px] font-semibold text-slate-700">{{ s["name"] }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- QR grid (tight, one page) -->
      <div class="mt-5 grid gap-3 grid-cols-2">
        {% for slug, name in CATEGORY_SLUGS.items() %}
          <a class="block rounded-2xl border border-slate-200 p-3 hover:bg-slate-50"
             href="{{ url_for('vote_qty_page', show_slug=show['slug'], car_token=car['car_token'], category_slug=slug) }}">
            <div class="cat-box flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-[11px] font-semibold text-slate-600">SCAN TO VOTE</div>
                <div class="text-base font-semibold text-slate-900 leading-tight">{{ name }}</div>
                <div class="mt-1 text-[11px] text-slate-600">$1 per vote • Scan & vote</div>
              </div>
              <div class="qr-box">
                <div id="qr-{{ slug }}" class="mx-auto w-fit"></div>
              </div>
            </div>
          </a>
        {% endfor %}
      </div>

      <div class="mt-4 flex items-center justify-between gap-3 text-xs text-slate-500">
        <div>Secure payments by Stripe</div>
        {% if show %}
          <div class="text-right">
            Print instructions: {{ url_for('voting_instructions', show_slug=show['slug'], _external=True) }}
          </div>
        {% endif %}
      </div>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
  (function () {
    const items = [
      {% for slug, name in CATEGORY_SLUGS.items() %}
        {
          id: "qr-{{ slug }}",
          url: "{{ url_for('vote_qty_page', show_slug=show['slug'], car_token=car['car_token'], category_slug=slug, _external=True) }}"
        }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    // Tuned to fit sponsor strip + car info on one page, still scannable.
    const QR_SIZE = 105;

    items.forEach((it) => {
      const el = document.getElementById(it.id);
      if (!el) return;
      el.innerHTML = "";
      new QRCode(el, {
        text: it.url,
        width: QR_SIZE,
        height: QR_SIZE,
        correctLevel: QRCode.CorrectLevel.H
      });
    });
  })();
</script>
{% endblock %}
